#
# Makefile.cfg for SRB2/PSP
#

#
#hmmm, the PSP
#

	PSPSDK=$(shell psp-config -p)
	PSPDEV=$(shell psp-config -d)
	PSPPREFIX=$(shell psp-config -P)
	STRIP=psp-strip
	MKSFO=mksfo
	PACK_PBP=pack-pbp
	FIXUP=psp-fixup-imports
	HOSTCC:=$(CC)
	CC=$(PSPDEV)/bin/psp-gcc
	OBJCOPY=psp-objcopy
	OBJDUMP=psp-objdump

ifndef ECHO
	MKSFO:=@$(MKSFO)
	PACK_PBP:=@$(PACK_PBP)
	FIXUP:=@$(FIXUP)
endif

	PSP_EBOOT_TITLE=SRB2-PSP v2.0.6
	PSP_EBOOT_SFO=$(BIN)/PARAM.SFO
	PSP_EBOOT_ICON=sdl/SRB2PSP/ICON0.png
	PSP_EBOOT_ICON1=NULL
	PSP_EBOOT_UNKPNG=NULL
	PSP_EBOOT_PIC1=sdl/SRB2PSP/PIC1.png
	PSP_EBOOT_SND0=NULL
	PSP_EBOOT_PSAR=NULL

	SIGNER?=sdl/SRB2PSP/psp-prxsign/psp-prxsign

	SDL=1
	PREFIX=psp
	NONX86=1
	NOHW=1
	NOHS=1
	NOMD5=1
	NONET=1       #No TCPIP code
	NOPNG=1       #No Screenshot

	OPTS=-DUNIXCOMMON -DFORCESDLMAIN -G0
	OPTS:=-I$(PSPSDK)/include $(OPTS)
	WFLAGS+=-O3
	LIBS=-lm
	SDL_CONFIG=$(PSPDEV)/psp/bin/sdl-config
	#SDL_CFLAGS?=-I$(PSPDEV)/psp/include/SDL
	#SDL_LDFLAGS?=-lSDLmain -lSDL -lglut -lGLU -lGL -lpspgu -lpspaudiolib -lpspaudio -lpsphprm -lpspvfpu -lpsprtc
ifndef NOMIXER
	LIBS:=-liberty -lvorbisfile -lvorbis -logg -lSDL $(LIBS)
endif
ifndef NOHW
	OPTS+=-DMINI_GL_COMPATIBILITY
	LIBS:=-lpsprtc -lpspvfpu $(LIBS)
endif
	PSPSDK_LIBS=-L$(PSPSDK)/lib -lpspdebug -lpspdisplay -lpspge -lpspctrl -lpspsdk
	LIBS+=$(PSPSDK_LIBS) -lc -lpspnet -lpspnet_inet -lpspnet_apctl -lpspnet_resolver -lpsputility -lpspuser -lpspkernel

	# name of the exefile
	EXENAME?=SRB2PSP.elf
	DBGNAME?=SRB2PSP.debug

post-build: fix-up $(BIN)/EBOOT.PBP

kxploit: $(BIN)/$(EXENAME) $(PSP_EBOOT_SFO)
	-$(MKDIR) "$(BIN)/kxploit/srb2"
	@echo emitting kxploit/srb2/
	$(STRIP) $(BIN)/$(EXENAME) -o $(BIN)/kxploit/srb2/EBOOT.PBP
	@echo emitting kxploit/srb2%
	-$(MKDIR) "$(BIN)/kxploit/srb2%/"
	$(PACK_PBP) "$(BIN)/kxploit/srb2%/EBOOT.PBP" $(PSP_EBOOT_SFO) $(PSP_EBOOT_ICON)  \
		$(PSP_EBOOT_ICON1) $(PSP_EBOOT_UNKPNG) $(PSP_EBOOT_PIC1)  \
		$(PSP_EBOOT_SND0) NULL $(PSP_EBOOT_PSAR)

sdl/SRB2PSP/PrxEncryper/PrxEncryper:
	-$(MAKE) -C sdl/SRB2PSP/PrxEncryper CFLAGS=-pipe CC="$(HOSTCC)"

fix-up: $(BIN)/$(EXENAME)
	@echo Running psp-fixup-imports on $(EXENAME)
	$(FIXUP) $(BIN)/$(EXENAME)

$(BIN)/EBOOT.PBP: fix-up $(SIGNER) $(PSP_EBOOT_SFO)
	@echo Signing and running pack-pbp to make PBP
	$(OBJCOPY) $(BIN)/$(EXENAME) $(BIN)/$(EXENAME).sign
	-$(SIGNER) $(BIN)/$(EXENAME) $(BIN)/$(EXENAME).sign
	$(PACK_PBP) $@ $(PSP_EBOOT_SFO) $(PSP_EBOOT_ICON)  \
		$(PSP_EBOOT_ICON1) $(PSP_EBOOT_UNKPNG) $(PSP_EBOOT_PIC1)  \
		$(PSP_EBOOT_SND0)  $(BIN)/$(EXENAME).sign $(PSP_EBOOT_PSAR)
	$(REMOVE)  $(BIN)/$(EXENAME).sign

$(PSP_EBOOT_SFO):
	-$(MKDIR) $(BIN)
	$(MKSFO) '$(PSP_EBOOT_TITLE)' $@

#include $(PSPSDK)/lib/build.mak
